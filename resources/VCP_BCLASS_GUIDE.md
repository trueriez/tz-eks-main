# VCP_BCLASS 설정 가이드

## 📌 요약

**`VCP_BCLASS`는 VPC의 IP 주소 대역을 설정하기 위한 B 클래스 값입니다.**

현재 설정: `"10.20"` → VPC CIDR: `10.20.0.0/16`

---

## VCP_BCLASS란?

### 정의
`VCP_BCLASS`는 **VPC (Virtual Private Cloud)의 IP 주소 범위**를 정의하는 변수입니다.

**VCP_BCLASS** = VPC의 첫 두 옥텟(B 클래스)을 의미합니다.

### 현재 설정 분석

```terraform
VCP_BCLASS = "10.20"
```

이 값으로부터:
- **VPC CIDR**: `10.20.0.0/16`
- **사용 가능한 IP 범위**: 10.20.0.0 ~ 10.20.255.255
- **총 IP 개수**: 65,536개

---

## IP 주소 할당 구조

### 1. VPC CIDR 블록

```terraform
VPC_CIDR = "${local.VCP_BCLASS}.0.0/16"
```

**결과**: `10.20.0.0/16`

**의미**:
- 네트워크 주소: 10.20.0.0
- 넷마스크: 255.255.0.0
- 사용 가능한 IP: 10.20.0.1 ~ 10.20.255.254
- 총 65,536개 IP 주소

---

### 2. Private Subnets (내부 네트워크)

```terraform
private_subnets = [
  for i in range(1, 10):
    "${local.VCP_BCLASS}.${i}.0/24"
]
```

**생성되는 서브넷**:
```
10.20.1.0/24   (10.20.1.0   ~ 10.20.1.255   - 256개 IP)
10.20.2.0/24   (10.20.2.0   ~ 10.20.2.255   - 256개 IP)
10.20.3.0/24   (10.20.3.0   ~ 10.20.3.255   - 256개 IP)
10.20.4.0/24   (10.20.4.0   ~ 10.20.4.255   - 256개 IP)
10.20.5.0/24   (10.20.5.0   ~ 10.20.5.255   - 256개 IP)
10.20.6.0/24   (10.20.6.0   ~ 10.20.6.255   - 256개 IP)
10.20.7.0/24   (10.20.7.0   ~ 10.20.7.255   - 256개 IP)
10.20.8.0/24   (10.20.8.0   ~ 10.20.8.255   - 256개 IP)
10.20.9.0/24   (10.20.9.0   ~ 10.20.9.255   - 256개 IP)
```

**총**: 9개 Private Subnet × 256 IP = **2,304개 IP**

**용도**:
- EKS Worker Nodes (EC2 인스턴스)
- RDS 데이터베이스
- ElastiCache
- 내부 로드밸런서
- 인터넷에 직접 노출되지 않는 리소스

---

### 3. Public Subnets (외부 네트워크)

```terraform
public_subnets = [
  for i in range(100, 110):
    "${local.VCP_BCLASS}.${i}.0/24"
]
```

**생성되는 서브넷**:
```
10.20.100.0/24  (10.20.100.0 ~ 10.20.100.255 - 256개 IP)
10.20.101.0/24  (10.20.101.0 ~ 10.20.101.255 - 256개 IP)
10.20.102.0/24  (10.20.102.0 ~ 10.20.102.255 - 256개 IP)
10.20.103.0/24  (10.20.103.0 ~ 10.20.103.255 - 256개 IP)
10.20.104.0/24  (10.20.104.0 ~ 10.20.104.255 - 256개 IP)
10.20.105.0/24  (10.20.105.0 ~ 10.20.105.255 - 256개 IP)
10.20.106.0/24  (10.20.106.0 ~ 10.20.106.255 - 256개 IP)
10.20.107.0/24  (10.20.107.0 ~ 10.20.107.255 - 256개 IP)
10.20.108.0/24  (10.20.108.0 ~ 10.20.108.255 - 256개 IP)
10.20.109.0/24  (10.20.109.0 ~ 10.20.109.255 - 256개 IP)
```

**총**: 10개 Public Subnet × 256 IP = **2,560개 IP**

**용도**:
- NAT Gateway
- Internet Gateway
- Bastion Host
- 외부 로드밸런서 (ALB/NLB)
- 인터넷에 직접 접근 가능한 리소스

---

## 네트워크 구조 다이어그램

```
VPC: 10.20.0.0/16 (65,536 IP)
│
├─── Private Subnets (내부망)
│    ├─ 10.20.1.0/24   → AZ-a (Worker Nodes)
│    ├─ 10.20.2.0/24   → AZ-b (Worker Nodes)
│    ├─ 10.20.3.0/24   → AZ-c (Worker Nodes)
│    ├─ 10.20.4.0/24   → AZ-a (Database)
│    ├─ 10.20.5.0/24   → AZ-b (Database)
│    └─ 10.20.6.0/24   → ... (예약)
│
└─── Public Subnets (외부망)
     ├─ 10.20.100.0/24 → AZ-a (Load Balancer)
     ├─ 10.20.101.0/24 → AZ-b (Load Balancer)
     ├─ 10.20.102.0/24 → AZ-c (NAT Gateway)
     └─ 10.20.103.0/24 → ... (예약)
```

---

## 변경 가능한 값

### 예시 1: 다른 B 클래스 사용

```terraform
# 10.30.x.x 대역 사용
VCP_BCLASS = "10.30"

# 결과:
# VPC CIDR: 10.30.0.0/16
# Private: 10.30.1.0/24 ~ 10.30.9.0/24
# Public:  10.30.100.0/24 ~ 10.30.109.0/24
```

### 예시 2: 172 대역 사용

```terraform
# 172.16.x.x 대역 사용 (AWS 권장)
VCP_BCLASS = "172.16"

# 결과:
# VPC CIDR: 172.16.0.0/16
# Private: 172.16.1.0/24 ~ 172.16.9.0/24
# Public:  172.16.100.0/24 ~ 172.16.109.0/24
```

### 예시 3: 192 대역 사용

```terraform
# 192.168.x.x 대역 사용
VCP_BCLASS = "192.168"

# 결과:
# VPC CIDR: 192.168.0.0/16
# Private: 192.168.1.0/24 ~ 192.168.9.0/24
# Public:  192.168.100.0/24 ~ 192.168.109.0/24
```

---

## RFC 1918 Private IP 범위

VPC에서 사용 가능한 사설 IP 주소 범위:

| 클래스 | IP 범위 | CIDR | 총 IP 개수 |
|--------|---------|------|-----------|
| **Class A** | 10.0.0.0 ~ 10.255.255.255 | 10.0.0.0/8 | 16,777,216 |
| **Class B** | 172.16.0.0 ~ 172.31.255.255 | 172.16.0.0/12 | 1,048,576 |
| **Class C** | 192.168.0.0 ~ 192.168.255.255 | 192.168.0.0/16 | 65,536 |

**현재 프로젝트**: Class A 범위 사용 (10.20.0.0/16)

---

## VCP_BCLASS 변경 시 주의사항

### ⚠️ 기존 VPC와 충돌 방지

다른 VPC나 온프레미스 네트워크와 IP 대역이 겹치지 않도록 해야 합니다.

**충돌 확인:**
```bash
# 현재 AWS 계정의 모든 VPC CIDR 확인
aws ec2 describe-vpcs \
  --query "Vpcs[].[VpcId, CidrBlock]" \
  --output table
```

**결과 예시:**
```
------------------------------------------
|            DescribeVpcs               |
+----------------------+----------------+
|  vpc-0123456789     |  10.20.0.0/16  | ← 현재 VPC
|  vpc-9876543210     |  10.10.0.0/16  | ← 다른 VPC
+----------------------+----------------+
```

만약 `10.10.0.0/16`이 이미 사용 중이라면, `10.20.x.x` 또는 `172.16.x.x` 등 다른 대역을 사용해야 합니다.

---

### 🔄 VPC Peering 고려사항

여러 VPC를 연결(Peering)할 계획이라면 각 VPC의 IP 대역이 겹치지 않아야 합니다.

**예시:**
```
VPC-1 (개발):   10.10.0.0/16
VPC-2 (스테이징): 10.20.0.0/16  ← 현재 설정
VPC-3 (프로덕션): 10.30.0.0/16
온프레미스:      192.168.0.0/16
```

---

### 🌐 VPN/Direct Connect 연결

온프레미스 네트워크와 VPN 또는 Direct Connect로 연결할 경우:

```
온프레미스:    192.168.0.0/16
AWS VPC:      10.20.0.0/16  ← 겹치지 않음 (OK)
```

---

## 현재 설정 확인

### Terraform 변수 확인

```bash
cd /Users/codesonic/Documents/Workspace/KUBE/tz-eks-main/terraform-aws-eks/workspace/base

# Terraform console로 확인
terraform console

# 다음 명령어 입력:
> var.VCP_BCLASS
"10.20"

> local.VPC_CIDR
"10.20.0.0/16"
```

---

### AWS CLI로 확인 (배포 후)

```bash
# VPC 정보 조회
aws ec2 describe-vpcs \
  --filters "Name=tag:Name,Values=topzone-k8s-vpc" \
  --query "Vpcs[].[VpcId, CidrBlock, Tags[?Key=='Name'].Value | [0]]" \
  --output table

# Subnet 정보 조회
aws ec2 describe-subnets \
  --filters "Name=vpc-id,Values=vpc-xxxxx" \
  --query "Subnets[].[SubnetId, CidrBlock, AvailabilityZone, MapPublicIpOnLaunch]" \
  --output table
```

---

## 권장 설정

### 환경별 권장 IP 대역

#### 소규모 프로젝트 (현재 설정)
```terraform
VCP_BCLASS = "10.20"
# VPC: 10.20.0.0/16 (65K IP)
# Private: 9개 서브넷 (2.3K IP)
# Public: 10개 서브넷 (2.5K IP)
```

#### 중규모 프로젝트
```terraform
VCP_BCLASS = "10.0"
# VPC: 10.0.0.0/16 (65K IP)
# 더 많은 서브넷 생성 가능
```

#### 대규모 프로젝트
```terraform
# 여러 VPC 사용
# Dev:     10.10.0.0/16
# Staging: 10.20.0.0/16
# Prod:    10.30.0.0/16
```

---

## 변경 방법

### 1. .auto.tfvars 파일 수정

```terraform
# 현재 설정
VCP_BCLASS = "10.20"

# 변경 예시
VCP_BCLASS = "172.16"
```

### 2. Terraform Plan 확인

```bash
cd terraform-aws-eks/workspace/base
terraform plan -var-file="../../resources/.auto.tfvars"
```

### 3. 변경 적용

```bash
terraform apply -var-file="../../resources/.auto.tfvars" -auto-approve
```

**⚠️ 주의**: VPC CIDR 변경은 기존 VPC를 삭제하고 새로 생성합니다. 데이터 손실 주의!

---

## IP 주소 계산기

### CIDR 표기법 이해

| CIDR | 넷마스크 | 사용 가능 IP | 용도 |
|------|---------|------------|------|
| /32 | 255.255.255.255 | 1 | 단일 호스트 |
| /24 | 255.255.255.0 | 256 | 서브넷 (현재 사용) |
| /20 | 255.255.240.0 | 4,096 | 대형 서브넷 |
| /16 | 255.255.0.0 | 65,536 | VPC (현재 사용) |
| /12 | 255.240.0.0 | 1,048,576 | 대형 VPC |
| /8  | 255.0.0.0 | 16,777,216 | 초대형 VPC |

### 현재 설정 계산

```
VPC: 10.20.0.0/16
├─ Private Subnet 1: 10.20.1.0/24  (254 호스트)
├─ Private Subnet 2: 10.20.2.0/24  (254 호스트)
├─ ...
├─ Public Subnet 1:  10.20.100.0/24 (254 호스트)
└─ Public Subnet 2:  10.20.101.0/24 (254 호스트)

총 사용: 19개 서브넷 × 256 IP = 4,864 IP
남은 IP: 65,536 - 4,864 = 60,672 IP (확장 가능)
```

---

## 트러블슈팅

### 문제 1: IP 고갈

**증상:**
```
Error: InsufficientFreeAddressesInSubnet
```

**해결:**
1. 더 큰 CIDR 블록 사용 (/24 → /20)
2. 추가 서브넷 생성
3. 사용하지 않는 리소스 정리

---

### 문제 2: CIDR 충돌

**증상:**
```
Error: InvalidVpc.Range
```

**해결:**
다른 IP 대역 사용:
```terraform
VCP_BCLASS = "10.30"  # 10.20이 아닌 다른 값
```

---

### 문제 3: 서브넷 생성 실패

**증상:**
```
Error: InvalidSubnet.Range
```

**해결:**
VPC CIDR 범위 내에서 서브넷 생성 확인

---

## 온라인 도구

### IP 계산기
- https://www.ipaddressguide.com/cidr
- https://cidr.xyz/
- http://www.subnet-calculator.com/

### 입력 예시
```
IP: 10.20.0.0
Netmask: /16 (255.255.0.0)

결과:
First IP: 10.20.0.1
Last IP:  10.20.255.254
Total:    65,534 usable IPs
```

---

## FAQ

### Q1: VCP_BCLASS를 변경해야 하나요?
**A**: 기본값 `10.20`으로 충분합니다. 다른 VPC나 온프레미스 네트워크와 충돌하지 않는 한 변경할 필요 없습니다.

### Q2: 왜 Private는 1~9, Public은 100~109인가요?
**A**: 명확한 구분을 위한 규칙입니다. 숫자만 보고도 Private/Public 구분 가능합니다.

### Q3: 서브넷을 더 추가할 수 있나요?
**A**: 가능합니다. `vpc.tf`에서 `range(1, 10)` → `range(1, 20)`으로 변경하면 더 많은 서브넷 생성됩니다.

### Q4: /16 대신 /8을 사용하면?
**A**: 너무 큰 CIDR은 관리가 어렵고, AWS 제한에 걸릴 수 있습니다. /16이 적절합니다.

### Q5: 172.16.x.x 대역을 사용해야 하나요?
**A**: 10.x.x.x와 172.16.x.x 모두 사설 IP입니다. 어느 것을 사용해도 무방하지만, 기존 네트워크와 충돌하지 않는 것을 선택하세요.

---

## 체크리스트

배포 전 확인:

- [ ] `VCP_BCLASS` 값이 설정되어 있는가? (현재: "10.20")
- [ ] 다른 VPC와 IP 대역이 겹치지 않는가?
- [ ] 온프레미스 네트워크와 충돌하지 않는가?
- [ ] VPC CIDR이 충분한 IP를 제공하는가? (65K IP)
- [ ] Private/Public 서브넷 개수가 적절한가?

---

## 요약

| 항목 | 값 | 설명 |
|------|-----|------|
| **VCP_BCLASS** | `"10.20"` | VPC IP 대역의 첫 두 옥텟 |
| **VPC CIDR** | `10.20.0.0/16` | 전체 VPC IP 범위 |
| **Private Subnets** | `10.20.1.0/24` ~ `10.20.9.0/24` | 9개 서브넷 (내부망) |
| **Public Subnets** | `10.20.100.0/24` ~ `10.20.109.0/24` | 10개 서브넷 (외부망) |
| **총 IP 개수** | 65,536 | /16 CIDR 블록 |
| **사용 IP** | ~4,864 | 19개 서브넷 |
| **남은 IP** | ~60,672 | 향후 확장 가능 |

---

**작성일**: 2025년 11월 14일  
**프로젝트**: KUBE (tz-eks-main)  
**현재 설정**: VCP_BCLASS = "10.20"  
**VPC CIDR**: 10.20.0.0/16

